 <html>
	<head>
    <meta charset="utf-8">
		<script>
				let canvas, ctx, flag = false, prevX = 0, currX = 0, prevY = 0, currY = 0, ws;
				let new_lines = [];
                let count = 0;
				let inGame = false;
                const decoder = new TextDecoder();
                
				function main() {
					/* Connect to the server */
					ws = new WebSocket('ws://localhost:9001');
					ws.binaryType = 'arraybuffer';
		
					ws.onopen = () => {
						/* Join the "room" of canvas 1 */
					};
		
					/* For every message we receive */
					ws.onmessage = (message) => {
                        //console.log("MSG DATA", message);
                        console.log("MESSAGE", message);
                        msgObj = JSON.parse(message.data);
                        //console.log("MSG OBJ", msgObj);
                        //console.log("MSG OBJ0", msgObj[0]);
                        switch (msgObj[0]) {
						/* Request a new animation frame on first draw */
                        case "drawing":
                            if (new_lines.length == 0) {
                                window.requestAnimationFrame(() => {
                                    //console.log(new_lines.length);
            
                                    new_lines.forEach((li) => {
                                        ctx.beginPath();
                                    
                                        if (li.length == 5) {
                                        ctx.arc(li[0], li[1], li[2], li[3], li[4]);
                                        } 
                                        else {
                                        ctx.moveTo(li[0], li[1]);
                                        //console.log(li[0], li[1]);
                                        var length = li.length - 2;
                                        
                                        var x = 2;
                                        var y = 3;
                                            while (length >= 0) {
                                            ctx.lineTo(li[x], li[y]);
                                            console.log(li[x], li[y]);
                                            length = length - 2;
                                            x += 2;
                                            y += 2;
                                            };
                                        }
                                            
                                        ctx.stroke();
                                        count++;
                                        //console.log(count);
                                        //console.log("STROKED");
                                        });
                                    new_lines = [];
                                    });
            
                                    
                                
                                    
                                }
                            /* Add this draw to the pending buffer */
                            f = new Uint16Array(Object.values(msgObj[1]));
                            //console.log("AA", f);
                            new_lines.push(f);
                            //console.log("added");
                            break;
                        case "scoreboard":
                            console.log('inside scoreboard');
                            d = function(){
                                var ul = document.createElement('ul');
                                ul.setAttribute('id','proList');

                                var t, tt;
                                productList = (Object.entries(msgObj[1]));

                                function removeAllChildNodes(parent) {
                                    while (parent.firstChild) {
                                        parent.removeChild(parent.firstChild);
                                    }
                                }
                                removeAllChildNodes(document.getElementById('renderList'));
                                document.getElementById('renderList').appendChild(ul);
                                productList.forEach(renderProductList);

                                function renderProductList(element, index, arr) {
                                    var li = document.createElement('li');
                                    li.setAttribute('class','item');
                                    
                                    ul.appendChild(li);
                                    
                                    t = document.createTextNode(element);
                                    
                                    li.innerHTML=li.innerHTML + element;
                                }
                            };
                            d();
                            console.log('CALLED');
                            break;
                        case "GAME START":
                            function fadeOut() {
                                ctx.fillStyle = "rgba(255,255,255,0.3)";
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                setTimeout(fadeOut,50);
                            }
                            fadeOut();
                            inGame = true;
                            ctx.strokeStyle = 'black';
                            num = 3;  
                            ctx.font = "120px Verdana";
                            ctx.strokeText(num.toString(),320,200);
                            num--;
                            var x = setInterval(function() {
                                if (num == 0) {
                                    clearInterval(x);
                                    return;
                                }
                                ctx.font = "120px Verdana";
                                ctx.strokeText(num.toString(),320,200);
                                // Output the result in an element with id="demo"
                                num--;
                                // If the count down is over, write some text 
                            }, 1000);
                            break;
                            
                        case "GAME OVER":
                            document.getElementById("countdown").innerHTML = msgObj[1] + " WINS";
                            var node = document.createElement("LI");
                            break;
                        }
					};
		
					canvas = document.getElementById('can');
					ctx = canvas.getContext("2d");
					w = canvas.width;
					h = canvas.height;
		
					ctx.strokeStyle = 'black';
					ctx.lineWidth = 2;

                    ctx.font = '30px Verdana';
                    
                    var textString = "Shape Racer";
                    textWidth = ctx.measureText(textString).width;
                    console.log("TEXT WIDTH", textWidth);
                    ctx.fillText(textString , (canvas.width / 2) - (textWidth / 2), 200);
                    var initialx = (canvas.width / 2) - (textWidth / 2) - 10;
                    ctx.beginPath();
                    ctx.moveTo(initialx, 190);
                    ctx.lineTo(initialx - 50, 190);
                    ctx.lineTo(initialx - 50, 190+200);
                    ctx.lineTo(initialx + 50 + 10 + textWidth + 10, 190+200);
                    ctx.lineTo(initialx + 50 + 10 + textWidth + 10, 190);
                    ctx.lineTo(initialx + 10 + textWidth + 10, 190);
                    ctx.stroke();
                    
                    textString = "Play";
                    ctx.font = '20px Verdana';
                   
                    textWidth = ctx.measureText(textString).width;
                    metrics = ctx.measureText(textString);
                    textHeight = (metrics.actualBoundingBoxAscent||0) + (metrics.actualBoundingBoxDescent||0);
                    console.log("TEXT WIDTH", textWidth);
                    ctx.fillText(textString , (canvas.width / 2) - (textWidth / 2), 250);
                    ctx.stroke();

                    var inTheThing = false;
                    const TLx = (canvas.width / 2) - (textWidth / 2) - 10 - 10;
                    const TLy = 250 - textHeight - 10;
                    const TRx = (canvas.width / 2) + (textWidth / 2) + 10 + 10;
                    const TRy = 250 - textHeight - 10;
                    const BLx = (canvas.width / 2) - (textWidth / 2) - 10 - 10;
                    const BLy = 250 + 10;
                    const BRx = (canvas.width / 2) + (textWidth / 2) + 10 + 10;
                    const BRy = 250 + 10;
					canvas.addEventListener("mousemove", function (e) {
                    
						currX = e.clientX / window.innerWidth * 720;
						currY = e.clientY / window.innerHeight * 480;
                        console.log(currX);
                        console.log(currY);
                        //&& (currX <= ((canvas.width / 2) + (textWidth / 2))) && (currY >= 300) && (currY <= (300 + textHeight)))
                        if ((currX >= ((canvas.width / 2) - (textWidth / 2))) && (currX <= ((canvas.width / 2) + (textWidth / 2))) && (currY <= 250) && (currY >= (250 - textHeight))) {
                            if (inTheThing == false) {
                                ctx.strokeStyle = 'black';
                                ctx.beginPath();
                                ctx.moveTo(TLx, TLy);
                                ctx.lineTo(TLx + 10, TLy);
                                ctx.moveTo(TLx, TLy);
                                ctx.lineTo(TLx, TLy + 10);
                                
                                ctx.moveTo(TRx, TRy);
                                ctx.lineTo(TRx - 10, TRy);
                                ctx.moveTo(TRx, TRy);
                                ctx.lineTo(TRx, TRy + 10);
                                
                                ctx.moveTo(BLx, BLy);
                                ctx.lineTo(BLx + 10, BLy);
                                ctx.moveTo(BLx, BLy);
                                ctx.lineTo(BLx, BLy - 10);
                                
                                ctx.moveTo(BRx, BRy);
                                ctx.lineTo(BRx - 10, BRy);
                                ctx.moveTo(BRx, BRy);
                                ctx.lineTo(BRx, BRy - 10);                                
                                ctx.stroke();
                            }
                            inTheThing = true;
                        } else {
                            if (inTheThing && !inGame) {
                            ctx.strokeStyle = "rgba(255,255,255,0.3)";
                            var j = 0;
                            var i = setInterval( function() { 
                                ctx.beginPath();
                                ctx.moveTo(TLx, TLy);
                                ctx.lineTo(TLx + 10, TLy);
                                ctx.moveTo(TLx, TLy);
                                ctx.lineTo(TLx, TLy + 10);
                                
                                ctx.moveTo(TRx, TRy);
                                ctx.lineTo(TRx - 10, TRy);
                                ctx.moveTo(TRx, TRy);
                                ctx.lineTo(TRx, TRy + 10);
                                
                                ctx.moveTo(BLx, BLy);
                                ctx.lineTo(BLx + 10, BLy);
                                ctx.moveTo(BLx, BLy);
                                ctx.lineTo(BLx, BLy - 10);
                                
                                ctx.moveTo(BRx, BRy);
                                ctx.lineTo(BRx - 10, BRy);
                                ctx.moveTo(BRx, BRy);
                                ctx.lineTo(BRx, BRy - 10);                                
                                ctx.stroke();       
                            j++;
                            if (j > 100) {clearInterval(i);console.log("CLEARRGANGG");}
                            
                            }, 50);  
                            inTheThing = false;
                            }                            
                        }
                    }, false);
                    
					canvas.addEventListener("mousedown", function (e) {
                    
						currX = e.clientX / window.innerWidth * 720;
						currY = e.clientY / window.innerHeight * 480;
                        console.log(currX);
                        console.log(currY);
                        //&& (currX <= ((canvas.width / 2) + (textWidth / 2))) && (currY >= 300) && (currY <= (300 + textHeight)))
                        if ((currX >= ((canvas.width / 2) - (textWidth / 2))) && (currX <= ((canvas.width / 2) + (textWidth / 2))) && (currY <= 250) && (currY >= (250 - textHeight))) {
                        console.log("sweet spot");
                        ws.send('play');
                        }
                        
						
					}, false);              
                   
                    const input = document.querySelector('input');
                    input.addEventListener("keyup", updateValue);

                    function updateValue(e) {
                      if (e.keyCode == 13) {
                        ws.send(e.target.value);
                        e.target.value = '';
                      }
                      
                    }
                      
                    const backButton = document.getElementsByTagName('button')[1];
                    backButton.addEventListener("click", backAction);
                    
                    function backAction(e) {
                        function removeAllChildNodes(parent) {
                            while (parent.firstChild) {
                                parent.removeChild(parent.firstChild);
                            }
                        }
                        removeAllChildNodes(document.getElementById('renderList'));
                        document.getElementById("countdown").innerHTML = "";
                      }
                    
				}
			</script>
    
	</head>
    <body onload="main()" style="margin: 0; height: 100vh; width: 100vw">
        <p id="countdown" style='position:fixed;top:50%;left:50%;transform: translate(-50%, -50%);'></p>
        <div id="renderList" style="position:fixed;top:10%;left:50%; height:10%; width: 20%;"></div>
        <!--<button style="background-color: white;color: black;border: 2px solid #4CAF50;position:fixed;top:50%;left:50%;transform: translate(-50%, -50%)">Play</button>
        <button>Back</button>-->
        <canvas id="can" width="720" height="480" style="height: 100%; width: 100%"></canvas>
        <input style='position:fixed;top:90%;left:50%;transform: translate(-50%, -50%);' placeholder="Enter some text" name="name"/>
    </body>
</html>
